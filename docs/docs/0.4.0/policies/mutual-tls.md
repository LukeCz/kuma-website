# Mutual TLS

This policy enables automatic encrypted mTLS traffic for all the services in a [`Mesh`](../mesh).

Kuma ships with a `builtin` CA (Certificate Authority) which is initialized with an auto-generated root certificate. The root certificate is unique for every [`Mesh`](../mesh) and it used to sign identity certificates for every data-plane. Kuma also supports third-party CA.

The mTLS feature is used for AuthN/Z as well: each data-plane is being assigned with a workload identity certificate, which is SPIFFE compatible. This certificate has a SAN set to `spiffe://<mesh name>/<service name>`. When Kuma enforces policies that require an identity, like [`TrafficPermission`](../traffic-permissions), it will extract the SAN from the client certificate and use it for every identity matching operation.

By default, mTLS is **not** enabled. You can enable Mutual TLS by updating the [`Mesh`](../mesh) policy with the `mtls` setting.

::: tip
With mTLS enabled, all traffic is denied by default.

Remember to apply a `TrafficPermission` policy to explictly allow legitimate traffic between certain Dataplanes.
:::

## Builtin CA

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Universal"
```yaml
type: Mesh
name: default
mtls:
  enabledBackend: ca-1 # enable mTLS 
  backends:
  - name: ca-1
    type: builtin # use Builtin CA (a unique Root CA certificate will be generated automatically)
    conf:
      caCert:
        RSAbits: 2048
        expiration: 87600h # 10 years
```

You can apply this configuration with `kumactl apply -f [file-path]`.
:::
::: tab "Kubernetes"

```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    enabledBackend: ca-1 # enable mTLS 
    backends:
    - name: ca-1
      type: builtin # use Builtin CA (a unique Root CA certificate will be generated automatically)
      conf:
        caCert:
          RSAbits: 2048
          expiration: 87600h # 10 years
```

You can apply this configuration with `kubectl apply -f [file-path]`.
:::
::::

### Access builtin CA

You can access the autogenerated certificates using [Secret Management](../documentation/secret-management.md). Builtin CA is stored with following pattern for Secrets name:
```
Key  => $MESH_NAME.ca-builtin-key-$NAME_OF_CA
Cert => $MESH_NAME.ca-builtin-cert-$NAME_OF_CA
```

Example for Mesh: default and CA name of ca-1

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Universal"
```sh
$ kumactl get secrets
MESH      NAME
default   default.ca-builtin-cert-ca-1
default   default.ca-builtin-key-ca-1
```
:::
::: tab "Kubernetes"
```sh
$ kubectl get secrets -n kuma-system --field-selector='type=system.kuma.io/secret'
NAME                           TYPE                    DATA   AGE
default.ca-builtin-cert-ca-1   system.kuma.io/secret   1      3m12s
default.ca-builtin-key-ca-1    system.kuma.io/secret   1      3m12s
```
:::
::::

::: tip
The default value for RSAbits is 2048 and for expiration is 10 years. If you want to use the default values you can omit `conf:` section. 
:::

## Provided CA

In some cases users might need to opt out of auto-generated Root CA certificates, e.g. to stay compliant with internal company policies.

To that end, Kuma supports another type of CA - `provided` CA.

Like the name implies, a user will have to provide a custom Root CA certificate and take a responsibility for managing its lifecycle.

To use Provided CA complete following steps

1. Provide key and certificate using [Secret Management](../documentation/secret-management.md)

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Universal"

```sh
$ cat secret-ca-cert.yaml
type: Secret
mesh: default
name: ca-cert
data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURFekNDQWZ1Z0F... # cert in Base64

$ kumactl apply -f secret-ca-cert.yaml

$ cat secret-ca-key.yaml
type: Secret
mesh: default
name: ca-key
data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQk... # key in Base64

$ kumactl apply -f secret-ca-key.yaml

$ kumactl get secrets
MESH      NAME
default   ca-cert
default   ca-key
```
:::
::: tab "Kubernetes"
```sh
$ cat secret-ca-cert.yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    kuma.io/mesh: default
  name: ca-cert
  namespace: kuma-system
data:
  value: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURHekNDQWdPZ0F3S... # cert in Base64
type: system.kuma.io/secret

$ kubectl apply -f secret-ca-cert.yaml

$ cat secret-ca-key.yaml
apiVersion: v1
kind: Secret
metadata:
  labels:
    kuma.io/mesh: default
  name: ca-key
  namespace: kuma-system
data:
  value: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS... # key in Base64
type: system.kuma.io/secret

$ kubectl apply -f secret-ca-key.yaml
```
:::
::::


2. Enable Provided CA on Mesh

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Universal"
```sh
echo "
type: Mesh
name: default
mtls:
  enabledBackend: ca-1
  backends:
  - name: ca-1
    type: provided
    config:
      cert:
        secret: ca-cert
      key:
        secret: ca-key
  " | kumactl apply -f -
```
:::
::: tab "Kubernetes"
```sh
echo "
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    enabledBackend: ca-1
    backends:
    - name: ca-1
      type: provided
      config:
        cert:
          secret: ca-cert
        key:
          secret: ca-key
" | kumactl apply -f -
```
:::
::::

::: warning
Root CA certificate provided by a user must meet certain constraints:
1. It MUST be a self-signed Root CA certificate (Intermediate CA certificates are not allowed)
2. It MUST have basic constraint `CA` set to `true` (see [X509-SVID: 4.1. Basic Constraints](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#41-basic-constraints))
3. It MUST have key usage extension `keyCertSign` set (see [X509-SVID: 4.3. Key Usage](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#43-key-usage))
4. It MUST NOT have key usage extension 'digitalSignature' set (see [X509-SVID: Appendix A. X.509 Field Reference](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#appendix-a-x509-field-reference))
5. It MUST NOT have key usage extension 'keyAgreement' set (see [X509-SVID: Appendix A. X.509 Field Reference](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#appendix-a-x509-field-reference))
6. It MUST NOT have key usage extension 'keyEncipherment' set (see [X509-SVID: Appendix A. X.509 Field Reference](https://github.com/spiffe/spiffe/blob/master/standards/X509-SVID.md#appendix-a-x509-field-reference))

If a provided certificate doesn't meet those constraints, applying Mesh with enabled Provided CA will fail.
:::

### Other ways of providing CA

Depending on your use case you may want to provide CA in a file or just in the configuration (during testing). You can do this in the following way

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Universal"
```yaml
type: Mesh
name: default
mtls:
  enabledBackend: ca-1
  backends:
  - name: ca-1
    type: provided
    config:
      cert:
        inline: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURHekNDQWdPZ0F3S... # cert in Base64
      key:
        file: /opt/cert.key
```
:::
::: tab "Kubernetes"
```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    enabledBackend: ca-1
    backends:
    - name: ca-1
      type: provided
      config:
        cert:
          inline: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURHekNDQWdPZ0F3S... # cert in Base64
        key:
          file: /opt/cert.key
```
:::
::::

If you decide to use Provided CA from file make sure it is consistent across all the instances of the Control Plane.

### CA change

To change CA from one to another, you have to first disable mTLS (by removing `enabledBackend` property) and then re-enable it with other CA. In the future Kuma will support CA rotation.

## Certificate rotation

Certificate Authority is used to generate certificate for Dataplanes, but unlike CA those certificates are not stored in the underling Kuma storage (Postgres/K8S Secrets).
Dataplane certificates are designed to be short-lived and often rotated. By default, the expiration time of a dataplane certificate is 30 days.
Kuma rotates dataplane certificates automatically after 4/5 of the certificate validity time (for the default 30 days expiration, it is 24 days).
 
You can modify the expiration time for any CA backend in the following way

:::: tabs :options="{ useUrlFragment: false }"
::: tab "Universal"
```yaml
type: Mesh
name: default
mtls:
  enabledBackend: ca-1
  backends:
  - name: ca-1
    type: builtin
    caCert:
      rotation:
        expiration: 48h
```
:::
::: tab "Kubernetes"
```yaml
apiVersion: kuma.io/v1alpha1
kind: Mesh
metadata:
  name: default
spec:
  mtls:
    enabledBackend: ca-1
    backends:
    - name: ca-1
      type: builtin
      caCert:
        rotation:
          expiration: 48h
```
:::
::::

You can check the statistics about the dataplane certificates using `kumactl inspect dataplanes`

```bash
$ kumactl inspect dataplanes
MESH      NAME     TAGS          STATUS   LAST CONNECTED AGO   LAST UPDATED AGO   TOTAL UPDATES   TOTAL ERRORS   CERT REGENERATED AGO   CERT EXPIRATION       CERT REGENERATIONS
default   web-01   service=web   Online   5s                   3s                 4               0              3s                     2020-05-11 16:01:34   2
```

Since certificates are not stored anywhere, any of the following action will cause new certificate generation.
* Restart of the control plane instance that the dataplane is connected to
* Restart of the dataplane
* Switch of the control plane instance that dataplane is connected to
